# Colormap Registry

An on-chain registry for colormaps.

The motivation for this was to provide an easy way to query a palette of colors based on some value. One can [**write util functions**](https://twitter.com/fiveoutofnine/status/1584932730579865600) to generate colors based on some values, but without a registry, the output is quite primitive. [`ColormapRegistry`](https://github.com/fiveoutofnine/colormap-registry/blob/main/src/ColormapRegistry.sol) was implemented to allow for _any_ possible colormap to be implemented in a generalized way. Thus, after computing and registering a colormap, any contract will be able to easily read and use the color value on-chain.

### Colormap identification

Colormaps on the registry are content addressed. This means colormaps are identified via the hash of their definition (see `_computeColormapHash` in [`ColormapRegistry`](https://github.com/fiveoutofnine/colormap-registry/blob/main/src/ColormapRegistry.sol), rather than a separate ID or name. It's not the optimal DX, but this way, the registry runs permissionlessly and immutably without an owner.

### Colormap definition

There are 2 ways to define a colormap:

1. via segment data
2. or via a [**palette generator**](https://github.com/fiveoutofnine/colormap-registry/blob/main/src/interfaces/IPaletteGenerator.sol).

Segment data contains 1 `uint256` each for red, green, and blue describing their intensity values along the colormap. Each `uint256` contains 24-bit words bitpacked together with the following structure (bits are right-indexed):

| Bits      | Meaning                                              |
| --------- | ---------------------------------------------------- |
| `23 - 16` | Position in the colormap the segment begins from     |
| `15 - 08` | Intensity of R, G, or B the previous segment ends at |
| `07 - 00` | Intensity of R, G, or B the next segment starts at   |

Given some position, the output will be computed via linear interpolations on the segment data for R, G, and B. A maximum of 10 of these 24-bit words fit within 256 bits, so up to 9 segments can be defined.

If you need more granularity or a nonlinear palette function, you may implement [`IPaletteGenerator`](https://github.com/fiveoutofnine/colormap-registry/blob/main/src/interfaces/IPaletteGenerator.sol) and define a colormap with that.

## Deployments

The following are deployments of [`ColormapRegistry`](https://github.com/fiveoutofnine/colormap-registry/blob/main/src/ColormapRegistry.sol). To see a list of registered colormaps, see [**REGISTERED_COLORMAPS.md**](https://github.com/fiveoutofnine/colormap-registry/blob/main/REGISTERED_COLORMAPS.md).

| Chain   | Chain ID | Address                                                                                                                          |
| ------- | -------- | -------------------------------------------------------------------------------------------------------------------------------- |
| Mainnet | 1        | [`0x0000000012883D1da628e31c0FE52e35DcF95D50`](https://etherscan.io/address/0x0000000012883D1da628e31c0FE52e35DcF95D50)          |
| Goerli  | 5        | [`0x0000000012883D1da628e31c0FE52e35DcF95D50`](https://goerli.etherscan.io/address/0x0000000012883D1da628e31c0FE52e35DcF95D50)   |
| Canto   | 7700     | [`0x0000000012883D1da628e31c0FE52e35DcF95D50`](https://evm.explorer.canto.io/address/0x0000000012883D1da628e31c0FE52e35DcF95D50) |

The deployments were deployed through the `ImmutableCreate2Factory` at `0x0000000000FFe8B47B3e2130213B802212439497` with the salt

```
0x00000000000000000000000000000000000000000e558e93fbb8d803204fdbdb
```

and the bytecode

```
0x608060405234801561001057600080fd5b50611068806100206000396000f3fe608060405234801561001057600080fd5b506004361061007d5760003560e01c8063730236ca1161005b578063730236ca14610125578063f14b4f3f14610145578063f948433014610158578063fd6d7d061461018757600080fd5b8063172327cd146100825780634420e486146100b55780637168be56146100ca575b600080fd5b610095610090366004610e47565b6101be565b604080519384526020840192909252908201526060015b60405180910390f35b6100c86100c3366004610e69565b6104b9565b005b6101006100d8366004610ea6565b60016020526000908152604090205473ffffffffffffffffffffffffffffffffffffffff1681565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020016100ac565b610138610133366004610ebf565b610553565b6040516100ac9190610ef5565b6100c8610153366004610f61565b61073f565b610095610166366004610ea6565b60006020819052908152604090208054600182015460029092015490919083565b61019a610195366004610ebf565b6107e6565b6040805160ff948516815292841660208401529216918101919091526060016100ac565b6000828152602081815260408083208151606081018352815480825260018301549482019490945260029091015491810191909152829182918691158015610228575060008281526001602052604090205473ffffffffffffffffffffffffffffffffffffffff16155b15610267576040517f6ed9c4db000000000000000000000000000000000000000000000000000000008152600481018390526024015b60405180910390fd5b60008781526001602052604090205473ffffffffffffffffffffffffffffffffffffffff16801561044b576040517ff471d7ac0000000000000000000000000000000000000000000000000000000081526004810188905273ffffffffffffffffffffffffffffffffffffffff82169063f471d7ac90602401602060405180830381865afa1580156102fd573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103219190610fe4565b6040517fe420264a0000000000000000000000000000000000000000000000000000000081526004810189905273ffffffffffffffffffffffffffffffffffffffff83169063e420264a90602401602060405180830381865afa15801561038c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103b09190610fe4565b6040517fcd580ff3000000000000000000000000000000000000000000000000000000008152600481018a905273ffffffffffffffffffffffffffffffffffffffff84169063cd580ff390602401602060405180830381865afa15801561041b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061043f9190610fe4565b955095509550506104b0565b60008881526020818152604091829020825160608101845281548082526001830154938201939093526002909101549281019290925261048b9089610aee565b61049982602001518a610aee565b6104a783604001518b610aee565b96509650965050505b50509250925092565b60006104c482610bc7565b60008181526001602090815260409182902080547fffffffffffffffffffffffff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff87169081179091558251848152918201529192507ff2d00828f226f5dd23b91aed5ba27bfd61a57ac84aed836d9171b2c08771f21091015b60405180910390a15050565b6060600080600061056486866107e6565b919450925090507f3031323334353637383941424344454600000000000000000000000000000000600f600485901c16602081106105a4576105a4610ffd565b1a60f81b7f3031323334353637383941424344454600000000000000000000000000000000600f8516602081106105dd576105dd610ffd565b1a60f81b7f3031323334353637383941424344454600000000000000000000000000000000600f600486901c166020811061061a5761061a610ffd565b1a60f81b7f3031323334353637383941424344454600000000000000000000000000000000600f86166020811061065357610653610ffd565b1a60f81b7f3031323334353637383941424344454600000000000000000000000000000000600f600487901c166020811061069057610690610ffd565b1a60f81b7f3031323334353637383941424344454600000000000000000000000000000000600f8716602081106106c9576106c9610ffd565b6040517fff00000000000000000000000000000000000000000000000000000000000000978816602082015295871660218701529386166022860152918516602385015284166024840152901a60f81b909116602582015260260160405160208183030381529060405293505050505b92915050565b600061074a82610c20565b90506107598260000151610c4f565b6107668260200151610c4f565b6107738260400151610c4f565b600081815260208181526040918290208451815584820180516001830155858401805160029093019290925583518581528651938101939093525192820192909252905160608201527f9b14bb94e1465f1fcfb06453c86dce8b6cb7240b254eea39298cc71ca5168da690608001610547565b6000828152602081815260408083208151606081018352815480825260018301549482019490945260029091015491810191909152829182918691158015610850575060008281526001602052604090205473ffffffffffffffffffffffffffffffffffffffff16155b1561088a576040517f6ed9c4db0000000000000000000000000000000000000000000000000000000081526004810183905260240161025e565b60008781526001602052604090205473ffffffffffffffffffffffffffffffffffffffff168015610a92576040517ff471d7ac000000000000000000000000000000000000000000000000000000008152660deea55900646460ff89168102600483018190529173ffffffffffffffffffffffffffffffffffffffff84169063f471d7ac90602401602060405180830381865afa15801561092f573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109539190610fe4565b816109605761096061102c565b04660deea5590064648373ffffffffffffffffffffffffffffffffffffffff1663e420264a846040518263ffffffff1660e01b81526004016109a491815260200190565b602060405180830381865afa1580156109c1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109e59190610fe4565b816109f2576109f261102c565b04660deea5590064648473ffffffffffffffffffffffffffffffffffffffff1663cd580ff3856040518263ffffffff1660e01b8152600401610a3691815260200190565b602060405180830381865afa158015610a53573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a779190610fe4565b81610a8457610a8461102c565b0496509650965050506104b0565b600088815260208181526040918290208251606081018452815480825260018301549382019390935260029091015492810192909252610ad29089610d38565b610ae082602001518a610d38565b6104a783604001518b610d38565b6000670de0b6b3a763ff9c8211610b055781610b0f565b670de0b6b3a763ff9c5b91505b81660deea559006464602885901c60ff16021015610b3657601883901c9250610b12565b62ffffff80841690601885901c1660ff601086901c8116660deea55900646490810291602888901c811682029181891681029160208a901c1602838803848403838310610ba25780828585030281610b9057610b9061102c565b04840198505050505050505050610739565b80828486030281610bb557610bb561102c565b049093039a9950505050505050505050565b6040517fffffffffffffffffffffffffffffffffffffffff000000000000000000000000606083901b16602082015260009081906034015b60405160208183030381529060405280519060200120905061073981610da7565b805160208083015160408085015181519384019490945282015260608101919091526000908190608001610bff565b60ff601082901c168015610c92576040517f524661ea0000000000000000000000000000000000000000000000000000000081526004810183905260240161025e565b601882901c5b8015610cf55760ff601082901c16828111610ce2576040517f524661ea0000000000000000000000000000000000000000000000000000000081526004810185905260240161025e565b5060ff601082901c16915060181c610c98565b5060ff811015610d34576040517f524661ea0000000000000000000000000000000000000000000000000000000081526004810183905260240161025e565b5050565b60005b8160ff16602884901c60ff161015610d5957601883901c9250610d3b565b62ffffff80841690601885901c1660ff601086901c811690602887901c81169080881690602089901c8116908816849003848403838310610ba25780828585030281610b9057610b9061102c565b600081815260208181526040918290208251606081018452815480825260018301549382019390935260029091015492810192909252151580610e0d575060008281526001602052604090205473ffffffffffffffffffffffffffffffffffffffff1615155b15610d34576040517fea82ade20000000000000000000000000000000000000000000000000000000081526004810183905260240161025e565b60008060408385031215610e5a57600080fd5b50508035926020909101359150565b600060208284031215610e7b57600080fd5b813573ffffffffffffffffffffffffffffffffffffffff81168114610e9f57600080fd5b9392505050565b600060208284031215610eb857600080fd5b5035919050565b60008060408385031215610ed257600080fd5b82359150602083013560ff81168114610eea57600080fd5b809150509250929050565b600060208083528351808285015260005b81811015610f2257858101830151858201604001528201610f06565b5060006040828601015260407fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f8301168501019250505092915050565b600060608284031215610f7357600080fd5b6040516060810181811067ffffffffffffffff82111715610fbd577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b80604052508235815260208301356020820152604083013560408201528091505092915050565b600060208284031215610ff657600080fd5b5051919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fdfea164736f6c6343000811000a
```

which was compiled with the compiler version `v0.8.17+commit.8df45f5f` and `1000000` optimizer runs. If you deploy this to other EVM chains, please make a PR to add it here.

## Usage

### Reading a colormap

The registry allows querying values with either a `uint8` in $[0, 255]$ or a 18 decimal fixed point number in $[0, 1]$ for extra resolution (see comments in [`ColormapRegistry`](https://github.com/fiveoutofnine/colormap-registry/blob/main/src/ColormapRegistry.sol) for more info).

To read a color's R, G, and B values from a colormap 42.195% along the way, you can run the following:

```sol
(uint256 r, uint256 g, uint256 b) = ColormapRegistry.getValue({
    _colormapHash: "COLORMAP_HASH",
    _position: 0.42195e18
});
```

To read a color's R, G, and B values from a colormap $\frac{42}{255}$ along the way, you can run the following:

```sol
(uint8 r, uint8 g, uint8 b) = ColormapRegistry.getValueAsUint8({ _colormapHash: "COLORMAP_HASH", _position: 42 });
```

To read a color as a 24-bit hexstring from a colormap $\frac{42}{255}$ along the way, you can run the following:

```sol
string memory colorHex = ColormapRegistry.getValueAsHexString({ _colormapHash: "COLORMAP_HASH", _position: 42 });
```

### Registering a colormap

To register a colormap via segment data, compute the segment data following the representation defined by the registry. Then, run the following:

```ts
ColormapRegistry.register(segmentData);
```

To register a colormap via a palette generator, first implement and deploy an instance of [`IPaletteGenerator`](https://github.com/fiveoutofnine/colormap-registry/blob/main/src/interfaces/IPaletteGenerator.sol). Then, run the following:

```ts
ColormapRegistry.register(paletteGenerator);
```

## Local development

This project uses [**Foundry**](https://github.com/foundry-rs/foundry) as its development/testing framework.

### Installation

First, make sure you have Foundry installed. Then, run the following commands to clone the repo and install its dependencies:

```sh
git clone https://github.com/fiveoutofnine/colormap-registry.git
cd colormap-registry
forge install
```

### Testing

To run tests, run the following command:

```sh
forge test
```

### Coverage

To view coverage, run the following command:

```sh
forge coverage
```

To generate a report, run the following command:

```sh
forge coverage --report lcov
```

> **Note**
> It may be helpful to use an extension like [**Coverage Gutters**](https://marketplace.visualstudio.com/items?itemName=ryanluker.vscode-coverage-gutters) to display the coverage over the code.

### Verifying `ColormapRegistry`

To verify the contract on Etherscan, run the following command:

```sh
forge verify-contract --chain-id $CHAIN_ID --num-of-optimizations 1000000 --watch --compiler-version $COMPILER_VERSION $DEPLOY_ADDRESS src/ColormapRegistry.sol:ColormapRegistry $ETHERSCAN_KEY
```

## Credits

This project was built by [**fiveoutofnine**](https://twitter.com/fiveoutofnine) for [**Curta**](https://curta.wtf).

The colormaps added in [`DeployScript`](https://github.com/fiveoutofnine/colormap-registry/blob/main/script/Deploy.s.sol) were adapted from [**matplotlib**](https://github.com/matplotlib/matplotlib) via [`generate_cmaps.py`](https://github.com/fiveoutofnine/colormap-registry/blob/main/generate_cmaps.py).
